<!DOCTYPE html>
<html>
<head>
    <title>Medical Scan Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .upload-area { border: 2px dashed #ddd; padding: 20px; text-align: center; margin: 10px 0; }
        .progress { width: 100%; background-color: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-bar { height: 20px; background-color: #007bff; border-radius: 4px; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>Medical Scan Upload</h1>
    
    <form id="uploadForm">
        <div class="form-group">
            <label for="scanName">Scan Name:</label>
            <input type="text" id="scanName" name="scan_name" required>
        </div>
        
        <div class="form-group">
            <label for="modality">Modality:</label>
            <input type="text" id="modality" name="modality" required>
        </div>
        
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" min="0" max="120" required>
        </div>
        
        <div class="form-group">
            <label for="sex">Sex:</label>
            <select id="sex" name="sex" required>
                <option value="">Select Sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="imageFile">Medical Image:</label>
            <div class="upload-area">
                <input type="file" id="imageFile" accept="image/*,.dcm" required>
                <p>Click to select or drag and drop your medical image here</p>
            </div>
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <button type="submit">Upload and Process</button>
    </form>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const file = document.getElementById('imageFile').files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            try {
                // Show progress
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressBar').style.width = '25%';
                
                // Get upload URL
                const uploadUrlResponse = await fetch('/api/generate-upload-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: file.name,
                        content_type: file.type
                    })
                });
                
                const uploadData = await uploadUrlResponse.json();
                document.getElementById('progressBar').style.width = '50%';
                
                // Upload to GCP
                await fetch(uploadData.upload_url, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });
                
                document.getElementById('progressBar').style.width = '75%';
                
                // Submit for processing
                const submitData = new FormData();
                submitData.append('scan_name', formData.get('scan_name'));
                submitData.append('modality', formData.get('modality'));
                submitData.append('age', formData.get('age'));
                submitData.append('sex', formData.get('sex'));
                submitData.append('image_url', uploadData.public_url);
                submitData.append('blob_name', uploadData.blob_name);
                
                const submitResponse = await fetch('/api/submit-scan', {
                    method: 'POST',
                    body: submitData
                });
                
                const result = await submitResponse.json();
                document.getElementById('progressBar').style.width = '100%';
                
                // Redirect to processing page
                window.location.href = `/processing/${result.submission_id}`;
                
            } catch (error) {
                console.error('Error:', error);
                alert('Upload failed. Please try again.');
                document.getElementById('progressContainer').style.display = 'none';
            }
        });
    </script>
</body>
</html>