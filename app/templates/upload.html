<!DOCTYPE html>
<html>
<head>
    <title>Medical Scan Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .upload-area { border: 2px dashed #ddd; padding: 20px; text-align: center; margin: 10px 0; }
        .progress { width: 100%; background-color: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-bar { height: 20px; background-color: #007bff; border-radius: 4px; width: 0%; transition: width 0.3s; }
        .status-message { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>Medical Scan Upload</h1>
    
    <form id="uploadForm">
        <div class="form-group">
            <label for="scanName">Scan Name:</label>
            <input type="text" id="scanName" name="scan_name" required>
        </div>
        
        <div class="form-group">
            <label for="modality">Modality:</label>
            <input type="text" id="modality" name="modality" required>
        </div>
        
        <div class="form-group">
            <label for="age">Age:</label>
            <input type="number" id="age" name="age" min="0" max="120" required>
        </div>
        
        <div class="form-group">
            <label for="sex">Sex:</label>
            <select id="sex" name="sex" required>
                <option value="">Select Sex</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="imageFile">Medical Image:</label>
            <div class="upload-area">
                <input type="file" id="imageFile" accept="image/*,.dcm" required>
                <p>Click to select or drag and drop your medical image here</p>
            </div>
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <button type="submit" id="submitBtn">Upload and Process</button>
    </form>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const file = document.getElementById('imageFile').files[0];
            const submitBtn = document.getElementById('submitBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            if (!file) {
                showStatus('Please select a file', 'error');
                return;
            }
            
            try {
                // Disable submit button and show progress
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressBar').style.width = '10%';
                
                // Get upload URL
                showStatus('Generating upload URL...', 'success');
                const uploadUrlResponse = await fetch('/api/generate-upload-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: file.name,
                        content_type: file.type
                    })
                });
                
                if (!uploadUrlResponse.ok) {
                    throw new Error(`Failed to generate upload URL: ${uploadUrlResponse.status}`);
                }
                
                const uploadData = await uploadUrlResponse.json();
                document.getElementById('progressBar').style.width = '30%';
                
                // Upload to GCP
                showStatus('Uploading file to cloud storage...', 'success');
                const uploadResponse = await fetch(uploadData.upload_url, {
                    method: 'PUT',
                    body: file,
                    headers: {
                        'Content-Type': file.type
                    }
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`File upload failed: ${uploadResponse.status}`);
                }
                
                document.getElementById('progressBar').style.width = '60%';
                
                // Submit for processing (this should return immediately)
                showStatus('Submitting for processing...', 'success');
                const submitData = new FormData();
                submitData.append('scan_name', formData.get('scan_name'));
                submitData.append('modality', formData.get('modality'));
                submitData.append('age', formData.get('age'));
                submitData.append('sex', formData.get('sex'));
                submitData.append('image_url', uploadData.public_url);
                submitData.append('blob_name', uploadData.blob_name);
                
                const submitResponse = await fetch('/api/submit-scan', {
                    method: 'POST',
                    body: submitData
                });
                
                if (!submitResponse.ok) {
                    throw new Error(`Submission failed: ${submitResponse.status}`);
                }
                
                const result = await submitResponse.json();
                document.getElementById('progressBar').style.width = '100%';
                
                // Show success message briefly before redirect
                showStatus('Scan submitted successfully! Redirecting to processing page...', 'success');
                
                // Redirect immediately after successful submission
                setTimeout(() => {
                    window.location.href = `/processing/${result.submission_id}`;
                }, 1000); // Small delay to show success message
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Upload failed: ${error.message}. Please try again.`, 'error');
                
                // Reset form state
                document.getElementById('progressContainer').style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload and Process';
            }
        });
        
        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
        }
    </script>
</body>
</html>